# MA20双方法预测系统 使用指南

## 📊 系统概述

系统现在支持**两种MA20预测方法并存**，可以相互对比验证：

### 1️⃣ 机器学习模型（ML）
- ✅ 使用训练好的模型 `trained_model.pkl`
- ✅ 基于历史数据学习的预测规律
- ✅ 自动提取技术特征进行预测
- ✅ 理论上准确率更高

### 2️⃣ 规则技术分析（Rule-based）
- ✅ 基于手工设计的技术指标
- ✅ 透明可解释的计算逻辑
- ✅ 针对不同时间窗口优化权重
- ✅ 不依赖训练数据，实时响应

---

## 🎯 三种使用模式

在侧边栏的"⚙️ 预测方法"中可以选择：

### 🔄 两种方法对比（推荐）
- 同时运行ML和规则两种方法
- 并排显示两种结果
- 自动计算差异和一致性
- **适合：需要相互验证和对比的场景**

### 🤖 仅机器学习模型
- 只使用ML模型预测
- 需要模型文件存在
- **适合：信任ML模型且追求预测准确率**

### 📊 仅规则技术分析
- 只使用规则方法
- 不需要模型文件
- **适合：理解技术逻辑，快速响应**

---

## 📈 规则方法的技术特征

### 计算的特征因子

1. **价格位置因子**
   - 当前价格相对MA20的百分比偏离
   - 反映当前价格的强弱位置

2. **动量因子**
   - 最近N天的价格变化率
   - 动量周期根据预测窗口动态调整

3. **趋势因子**
   - MA5相对MA20的位置关系
   - 反映短期趋势方向

4. **成交量因子**
   - 当前成交量相对5日均量的变化
   - 反映资金流向强度

### 不同时间窗口的权重策略

| 时间窗口 | 权重分配 | 预测逻辑 |
|---------|---------|---------|
| **1天** | 价格位置40% + 动量40% + 成交量20% | 重点关注短期动量和资金流向 |
| **3天** | 价格位置40% + 动量30% + 趋势30% | 平衡考虑位置、动量和趋势 |
| **5天** | 价格位置30% + 动量20% + 趋势50% | 更重视中短期趋势的延续性 |
| **10天** | 价格位置50% + 趋势50% | 主要看中期趋势和技术位置 |

---

## 🔍 对比分析界面

当选择"两种方法对比"模式时，界面显示：

### 左侧：🤖 机器学习模型
- 数据表格显示各时间窗口预测
- 柱状图可视化概率分布

### 右侧：📊 规则技术分析
- 数据表格显示各时间窗口预测
- 柱状图可视化概率分布

### 底部：🔍 方法对比分析
对比表格包含：
- **时间窗口**：1天、3天、5天、10天
- **ML概率**：机器学习预测的强势概率
- **规则概率**：规则方法预测的强势概率
- **差异**：两种方法的概率差异
- **结论**：
  - ✅ 一致：两种方法预测方向相同
  - ⚠️ 分歧：两种方法预测方向不同

---

## 💡 使用建议

### 1. 初次使用
选择"🔄 两种方法对比"，了解两种方法的差异

### 2. 一致性分析
- 当两种方法**都预测强势且一致**：可信度高✅
- 当两种方法**预测分歧**：需谨慎，进一步分析⚠️
- 当两种方法**都预测弱势且一致**：回避信号🚫

### 3. 差异解读
- **差异 < 10%**：方法基本一致，可信度高
- **差异 10-20%**：存在一定分歧，需结合其他信号
- **差异 > 20%**：严重分歧，建议观望

### 4. 综合决策
系统会优先使用ML模型结果进行综合决策（如果ML模型可用），如果ML预测失败，则使用规则方法作为后备。

---

## 🛠️ 技术架构

```
StreamlitPredictor
├── predict_ma20_ml()          # 机器学习预测
│   ├── 加载训练好的模型
│   ├── 计算技术特征
│   └── 使用模型预测
│
├── predict_ma20_rule_based()  # 规则方法预测
│   ├── 计算价格位置因子
│   ├── 计算动量因子
│   ├── 计算趋势因子
│   ├── 计算成交量因子
│   └── 根据时间窗口加权
│
└── predict_ma20()             # 统一接口
    ├── method='ml'    → 仅ML
    ├── method='rule'  → 仅规则
    └── method='both'  → 两种方法对比
```

---

## 📦 依赖文件

### 必需文件
- `app_streamlit.py` - 主程序
- `stock_feature_engineering.py` - 特征工程（ML方法需要）

### 可选模型文件
- `models/trained_model.pkl` - ML模型（没有则只能用规则方法）
- `models/feature_list.pkl` - 特征列表（ML方法需要）
- `models/multi_horizon_models.pkl` - 多时间窗口模型（形态预测）

---

## 🚀 快速开始

```bash
# 启动应用
streamlit run app_streamlit.py

# 1. 在侧边栏选择预测方法
# 2. 输入股票代码（如：600519）
# 3. 点击"开始预测"
# 4. 查看"📈 MA20预测"标签页的对比结果
```

---

## ⚠️ 注意事项

1. **ML模型依赖**
   - 如果 `trained_model.pkl` 不存在，ML方法会自动失败
   - 系统会自动fallback到规则方法
   
2. **特征工程**
   - ML方法需要 `stock_feature_engineering.py` 中的特征计算
   - 特征必须与训练时保持一致

3. **性能考虑**
   - "两种方法对比"模式计算量大约是单一方法的2倍
   - 建议在网络稳定时使用

4. **结果解读**
   - 两种方法基于不同原理，分歧是正常的
   - 建议结合形态信号进行综合判断

---

## 📞 问题反馈

如遇到问题：
1. 检查模型文件是否存在
2. 查看控制台错误信息
3. 尝试切换到"仅规则方法"模式

**祝您使用愉快！** 📈✨

