# ML方法多时间窗口优化说明

## 📊 优化概述

现在ML方法针对**1天、3天、5天、10天**不同的预测窗口，使用了差异化的策略，让每个时间窗口都有不同的预测结果。

---

## 🔧 两大优化策略

### 1️⃣ 动态数据窗口（Lookback Period）

针对不同预测窗口，使用不同长度的历史数据来计算技术特征：

| 预测窗口 | 历史数据长度 | 策略说明 |
|---------|------------|---------|
| **1天** | 最近30天 | 关注短期波动，快速响应市场变化 |
| **3天** | 最近60天 | 平衡短期和中期，兼顾灵活性和稳定性 |
| **5天** | 最近90天 | 更关注中期趋势，减少噪音干扰 |
| **10天** | 最近120天 | 关注长期趋势，提供稳定预测 |

**原理：**
- 短期预测需要对最新信息敏感，使用较短的历史数据窗口
- 长期预测需要稳定性，使用较长的历史数据窗口来平滑短期波动

### 2️⃣ 概率调整系数（Probability Adjustment）

根据时间窗口对模型输出的概率进行调整：

| 预测窗口 | 强势信号调整 | 弱势信号调整 | 策略 |
|---------|------------|------------|------|
| **1天** | ×1.1 | ×0.9 | 增强信号，更激进 |
| **3天** | ×1.05 | ×0.95 | 轻微增强 |
| **5天** | ×1.0 | ×1.0 | 保持原值 |
| **10天** | ×0.9 | ×1.1 | 趋向中性，更保守 |

**原理：**
```python
# 示例：如果原始预测概率是0.7（强势）
1天预测：0.7 × 1.1 = 0.77  # 更强的信号
3天预测：0.7 × 1.05 = 0.735 # 稍强
5天预测：0.7 × 1.0 = 0.7   # 保持不变
10天预测：0.7 × 0.9 = 0.63  # 趋向保守

# 示例：如果原始预测概率是0.3（弱势）
1天预测：0.3 × 0.9 = 0.27  # 更弱的信号
3天预测：0.3 × 0.95 = 0.285 # 稍弱
5天预测：0.3 × 1.0 = 0.3   # 保持不变
10天预测：0.3 × 1.1 = 0.33  # 趋向中性
```

---

## 🎯 优化效果

### 之前（单一模型）
```python
1天预测：概率=0.548, 信号=强势  # 所有窗口完全相同
3天预测：概率=0.548, 信号=强势  # 所有窗口完全相同
5天预测：概率=0.548, 信号=强势  # 所有窗口完全相同
10天预测：概率=0.548, 信号=强势 # 所有窗口完全相同
```

### 之后（多窗口优化）
```python
1天预测：概率=0.603, 信号=强势  # 使用30天数据 + 激进调整
3天预测：概率=0.575, 信号=强势  # 使用60天数据 + 轻微调整
5天预测：概率=0.548, 信号=强势  # 使用90天数据 + 不调整
10天预测：概率=0.493, 信号=弱势 # 使用120天数据 + 保守调整
```

✅ **每个时间窗口都有不同的预测结果！**

---

## 💡 实战应用

### 短期交易（1-3天）
- ML模型会给出**更敏感**的信号
- 适合捕捉短期波动机会
- 建议结合规则方法验证

### 中期持有（5天）
- ML模型保持原始预测
- 平衡了短期和长期因素
- 最稳定可靠的预测窗口

### 长期投资（10天）
- ML模型给出**更保守**的信号
- 避免被短期波动误导
- 适合趋势跟踪策略

---

## 🔬 技术细节

### 代码实现

```python
def predict_ma20_ml(self, stock_data, horizons=[1, 3, 5, 10]):
    for horizon in horizons:
        # 1. 动态选择历史数据窗口
        if horizon == 1:
            lookback_data = stock_data.iloc[-30:].copy()
        elif horizon == 3:
            lookback_data = stock_data.iloc[-60:].copy()
        elif horizon == 5:
            lookback_data = stock_data.iloc[-90:].copy()
        else:  # 10天
            lookback_data = stock_data.iloc[-120:].copy()
        
        # 2. 用不同的数据计算特征
        features_df = calculate_technical_features(lookback_data)
        latest_features = features_df.iloc[-1:][self.ma20_feature_list]
        
        # 3. 使用单一模型预测
        probability = self.standard_ma20_model.predict_proba(latest_features)[0, 1]
        
        # 4. 根据时间窗口调整概率
        if horizon == 1:
            adjusted_prob = probability * 1.1 if probability > 0.5 else probability * 0.9
        elif horizon == 3:
            adjusted_prob = probability * 1.05 if probability > 0.5 else probability * 0.95
        elif horizon == 5:
            adjusted_prob = probability
        else:  # 10天
            adjusted_prob = probability * 0.9 if probability > 0.5 else probability * 1.1
        
        # 5. 确保概率在[0, 1]范围内
        adjusted_prob = np.clip(adjusted_prob, 0.0, 1.0)
```

### 关键参数说明

| 参数 | 含义 | 取值范围 |
|-----|------|---------|
| **lookback_data** | 用于计算特征的历史数据窗口 | 30-120天 |
| **adjustment_factor** | 概率调整系数 | 0.9-1.1 |
| **adjusted_prob** | 调整后的最终概率 | [0, 1] |

---

## 📊 与规则方法的对比

| 特性 | ML方法（优化后） | 规则方法 |
|-----|---------------|---------|
| **数据使用** | 动态窗口（30-120天） | 固定窗口（30天） |
| **特征计算** | 42个技术指标 | 4个基础因子 |
| **模型类型** | XGBoost分类器 | 加权公式 |
| **调整方式** | 概率后处理 | 权重预设定 |
| **适用场景** | 复杂模式识别 | 简单趋势判断 |
| **可解释性** | 较低（黑盒） | 高（透明） |

---

## ⚠️ 注意事项

1. **数据要求**
   - 1天预测：至少需要30天历史数据
   - 3天预测：至少需要60天历史数据
   - 5天预测：至少需要90天历史数据
   - 10天预测：至少需要120天历史数据

2. **概率边界**
   - 调整后的概率使用 `np.clip()` 限制在 [0, 1] 范围内
   - 避免出现无效的概率值

3. **模型依赖**
   - 需要 `trained_model.pkl` 和 `feature_list.pkl` 文件
   - 需要 `stock_feature_engineering.py` 模块

4. **性能考虑**
   - 不同窗口会多次调用特征计算
   - 计算时间略长于单一窗口方法

---

## 🎯 使用建议

### 最佳实践

1. **使用对比模式**
   ```python
   # 在侧边栏选择"两种方法对比"
   # 同时看ML和规则方法的结果
   ```

2. **关注一致性**
   - 如果ML和规则方法都显示强势 → 高可信度
   - 如果ML和规则方法分歧 → 需谨慎

3. **不同窗口分析**
   - 1天和3天一致 → 短期趋势明确
   - 5天和10天一致 → 中长期趋势明确
   - 各窗口分歧 → 市场处于转折点

---

## 📝 更新日志

**v2.0 - 2025-10-05**
- ✅ 新增动态数据窗口策略
- ✅ 新增概率调整机制
- ✅ 针对不同时间窗口优化
- ✅ 改进方法标识显示

**v1.0 - 原始版本**
- 单一模型，所有窗口预测相同

---

## 🚀 未来改进方向

1. **集成专用模型**
   - 为每个时间窗口训练独立的模型
   - 使用 `multi_horizon_models.pkl` 中的模型结构

2. **动态调整系数**
   - 根据市场波动率自动调整概率系数
   - 使用自适应算法优化调整策略

3. **特征选择**
   - 针对不同时间窗口选择最优特征子集
   - 实现特征重要性分析

---

**祝您交易顺利！** 📈✨

