# 完整运行指南

## 📋 系统概述

本系统是一个**多时间窗口股票预测系统**，通过同时预测1天、3天、5天、10天的股票走势来实现互相验证，提高预测准确性。

## 🎯 运行流程图

```
步骤1: 环境准备
    ↓
步骤2: 下载股票数据
    ↓
步骤3: 特征工程处理
    ↓
步骤4: 训练MA20预测模型
    ↓
步骤5: 训练多时间窗口模型
    ↓
步骤6: 实盘预测
```

---

## 步骤1: 环境准备

### 1.1 检查Python版本

```bash
python --version
```

**要求：** Python 3.8 或更高版本

### 1.2 安装依赖包

```bash
# 基础科学计算包
pip install pandas numpy scipy

# 机器学习包
pip install scikit-learn xgboost lightgbm

# 不平衡数据处理
pip install imbalanced-learn

# 时间序列特征提取
pip install tsfresh

# 数据可视化
pip install matplotlib seaborn

# 股票数据获取
pip install efinance akshare

# 小波变换（可选）
pip install pywt
```

**或者一次性安装：**

```bash
pip install pandas numpy scipy scikit-learn xgboost lightgbm imbalanced-learn tsfresh matplotlib seaborn efinance akshare pywt
```

### 1.3 验证安装

```bash
python -c "import pandas, numpy, sklearn, xgboost, lightgbm, imblearn, tsfresh, matplotlib, efinance; print('所有包安装成功')"
```

---

## 步骤2: 下载股票数据

### 2.1 运行数据下载脚本

```bash
python stock_data_downloader.py
```

**功能：**
- 从龙虎榜获取活跃股票代码
- 自动过滤ST股和次新股
- 下载K线数据和资金流数据
- 计算技术指标
- 保存到 `data/` 目录

**预期输出：**
```
================================================================================
股票数据下载工具
================================================================================
开始时间: 2025-10-05 XX:XX:XX

步骤1: 获取龙虎榜活跃股票
------------------------------------------------------------
正在获取龙虎榜数据...
获取到 XXX 条龙虎榜记录

开始过滤股票...
  原始股票数量: XX
  排除ST股: True
  排除次新股: True

过滤结果统计:
  通过过滤: XX 只
  排除ST股: X 只
  排除次新股: X 只

步骤2: 下载股票增强数据
------------------------------------------------------------
处理股票: 600519
  获取 600519 的K线数据...
  获取到 XXX 条K线记录
  获取 600519 的资金流数据...
  计算 600519 的技术指标...
  [OK] 600519 数据处理完成，数据记录: XXX 条

总共成功处理 XX 只股票的数据
已保存到: data/all_stock_data.pkl
```

**生成文件：**
- `data/all_stock_data.pkl` - 所有股票数据（主文件）
- `data/stock_XXXXXX_data.csv` - 单个股票数据（可选）
- `data/stock_list.csv` - 股票列表

**常见问题：**

**Q: 如果下载失败怎么办？**
```bash
# 检查网络连接
ping baidu.com

# 重试下载
python stock_data_downloader.py
```

**Q: 如何调整股票数量？**

编辑 `stock_data_downloader.py`，修改：
```python
max_stocks = 30  # 改为想要的数量
min_frequency=2   # 降低频率要求获取更多股票
```

---

## 步骤3: 特征工程处理

### 3.1 运行特征工程脚本

```bash
python stock_feature_engineering.py
```

**功能：**
- 将股票数据转换为TSFresh格式
- 提取时间序列特征
- 特征选择和筛选
- 保存处理后的特征

**预期输出：**
```
================================================================================
股票特征工程处理
================================================================================
开始时间: 2025-10-05 XX:XX:XX

步骤1: 加载股票数据
------------------------------------------------------------
成功加载 XX 只股票的数据

步骤2: 转换为TSFresh格式
------------------------------------------------------------
窗口大小: 20天
预测期限: 5天
生成的特征数据形状: (XXXX, X)
生成的目标数据形状: (XXXX, 2)

步骤3: 特征提取和选择
------------------------------------------------------------
开始提取增强TSFresh特征...
使用精简特征集（速度快，推荐）
系统CPU核心数: X
使用多线程模式，最优线程数: X

开始并行提取 9 种特征类型...
[OK] Close 特征提取完成，特征数: XXX
[OK] Volume 特征提取完成，特征数: XXX
...

多线程特征提取完成，总耗时: XX.XX秒
提取的原始特征数量: XXXX

🚀 V2.4 精确率提升 - 智能特征选择
第一阶段: 统计筛选...
  统计筛选保留: XXX 个特征
第二阶段: 重要性筛选...
  重要性筛选保留: XXX 个特征（累计重要性95%）
[OK] 最终特征数量: XXX

步骤4: 保存处理后的特征
------------------------------------------------------------
[OK] 特征数据已保存到: data/
   - processed_features.csv (XXX 个特征)
   - processed_targets.csv (XXXX 个样本)
   - processed_features.pkl (pickle格式，加载更快)
```

**生成文件：**
- `data/processed_features.csv` - 特征数据
- `data/processed_targets.csv` - 目标变量
- `data/processed_features.pkl` - 打包数据（推荐）

**耗时估算：**
- 10只股票：约5-10分钟
- 30只股票：约15-30分钟
- 50只股票：约30-60分钟

---

## 步骤4: 训练MA20预测模型

### 4.1 运行统计分析脚本

```bash
python stock_statistical_analysis.py
```

**功能：**
- 训练MA20状态分类模型
- 训练RandomForest、XGBoost、LightGBM
- 自动阈值优化
- 模型评估和可视化
- 保存训练好的模型

**预期输出：**
```
================================================================================
股票统计分析
基于MA20的二分类预测：价格>=MA20(强势) vs 价格<MA20(弱势)
================================================================================

步骤1: 加载处理后的特征
------------------------------------------------------------
从pickle文件加载（更快）...
[OK] 加载完成: XXX 个特征, XXXX 个样本

步骤2: 清理特征名称
------------------------------------------------------------
[OK] 特征名称清理完成

步骤3: 数据分割
------------------------------------------------------------
训练集: XXXX 样本
测试集: XXX 样本

步骤4: 模型训练
------------------------------------------------------------
训练二分类模型（V2.4.2优化版）...
🎯 优化目标: 提高精确率至75%+，确保召回率平衡

训练集类别分布:
  0: 价格>=MA20(强势) - XXXX 样本 (XX.XX%)
  1: 价格<MA20(弱势) - XXXX 样本 (XX.XX%)

使用SMOTE过采样平衡数据集...
平衡后训练集大小: XXXX

1️⃣ 训练Random Forest模型...
   [OK] Random Forest训练完成

2️⃣ 训练XGBoost模型...
   [OK] XGBoost训练完成

3️⃣ 训练LightGBM模型...
   [OK] LightGBM训练完成

📊 评估 3 个模型...
  RandomForest: 平均精确率=XX.XX% (阈值=0.XXX)
  XGBoost: 平均精确率=XX.XX% (阈值=0.XXX)
  LightGBM: 平均精确率=XX.XX% (阈值=0.XXX)

🏆 最佳模型: RandomForest (精确率=XX.XX%)

📊 模型性能评估
整体准确率: 0.XXXX
精确率对比:
  强势类别: XX.XX%
  弱势类别: XX.XX%
  平均精确率: XX.XX%

步骤8: 保存模型用于实盘预测
------------------------------------------------------------
[OK] 最佳模型已保存到: models/trained_model.pkl
[OK] 所有模型已保存到: models/all_trained_models.pkl (共3个模型)
[OK] 特征列表已保存到: models/feature_list.pkl
[OK] 模型信息已保存到: models/model_info.pkl
```

**生成文件：**
- `models/trained_model.pkl` - 最佳模型
- `models/all_trained_models.pkl` - 所有模型
- `models/feature_list.pkl` - 特征列表
- `models/model_info.pkl` - 模型信息
- `results/binary_classification_results.png` - 结果可视化

---

## 步骤5: 训练多时间窗口模型 ⭐

### 5.1 运行多时间窗口预测系统

```bash
python multi_horizon_prediction_system.py
```

**功能：**
- 训练1天、3天、5天、10天的预测模型
- 自动进行模型评估
- 生成演示预测
- 保存多时间窗口模型

**预期输出：**
```
================================================================================
多时间窗口预测系统
同时使用1天、3天、5天、10天预测进行互相验证
================================================================================
开始时间: 2025-10-05 XX:XX:XX

步骤1: 加载股票数据
------------------------------------------------------------
[OK] 成功加载 XX 只股票

步骤2: 创建多时间窗口预测器
------------------------------------------------------------

步骤3: 训练多时间窗口模型
------------------------------------------------------------

================================================================================
训练多时间窗口模型
================================================================================

================================================================================
训练1天预测模型
================================================================================

准备1天预测数据...
  识别形态特征...
  [OK] 形态特征提取完成，增加 31 个特征
  样本数: XXXX, 信号比例: X.XX%

  使用SMOTE平衡数据
  训练Random Forest...

  性能指标:
    准确率: XX.XX%
    精确率: XX.XX%
    召回率: XX.XX%
  [OK] 1天模型训练完成

================================================================================
训练3天预测模型
================================================================================
（类似输出...）

================================================================================
训练5天预测模型
================================================================================
（类似输出...）

================================================================================
训练10天预测模型
================================================================================
（类似输出...）

================================================================================
[OK] 所有模型训练完成！共4个模型
================================================================================

步骤4: 保存模型
------------------------------------------------------------
[OK] 多时间窗口模型已保存: models/multi_horizon_models.pkl

步骤5: 演示预测
------------------------------------------------------------

================================================================================
预测股票: 002104
================================================================================

多时间窗口预测:
  [-] 1天: 无信号 (概率:32.2%, 置信:67.8%)
  [-] 3天: 无信号 (概率:30.5%, 置信:69.5%)
  [-] 5天: 无信号 (概率:29.6%, 置信:70.4%)
  [-] 10天: 无信号 (概率:33.7%, 置信:66.3%)

[-] 综合决策:
  级别: 避免
  行动: 不建议交易
  一致性: 0/4
  置信度: 68.5%

[OK] 可视化图表已保存: results/multi_horizon_prediction_002104.png
```

**生成文件：**
- `models/multi_horizon_models.pkl` - 多时间窗口模型（核心文件）
- `results/multi_horizon_prediction_*.png` - 预测可视化图表

**耗时估算：**
- 约10-20分钟（取决于数据量）

---

## 步骤6: 实盘预测

### 6.1 方法A：多时间窗口预测（推荐）

```bash
python stock_multi_horizon_live_prediction.py
```

**交互流程：**
```
================================================================================
股票实盘多时间窗口综合预测
结合MA20状态 + 形态信号 + 多时间窗口验证
================================================================================

加载预测模型...
[OK] 成功加载多时间窗口模型
[OK] 成功加载MA20状态预测模型

请输入要预测的股票代码（多个用逗号分隔）:
示例: 600519,000001,002415
股票代码（回车使用默认）: 600519

================================================================================
多时间窗口综合预测 - 600519
================================================================================

获取600519实时数据...
[OK] 获取到 XXX 条记录

================================================================================
1️⃣ MA20状态多时间窗口预测（价格相对MA20）
================================================================================

MA20状态预测结果:
  [+] 1天后: 强势(≥MA20) (置信度:75.3%)
  [+] 3天后: 强势(≥MA20) (置信度:72.1%)
  [*] 5天后: 弱势(<MA20) (置信度:55.8%)
  [-] 10天后: 弱势(<MA20) (置信度:68.2%)

================================================================================
2️⃣ 形态信号多时间窗口预测（反转/回调/反弹）
================================================================================

形态信号预测结果:
  [+] 1天后: 有信号 (置信度:82.5%)
  [+] 3天后: 有信号 (置信度:78.3%)
  [*] 5天后: 无信号 (置信度:58.1%)
  [-] 10天后: 无信号 (置信度:71.5%)

================================================================================
3️⃣ 综合决策
================================================================================

综合决策结果:
--------------------------------------------------------------------------------

[+] 1天预测: 强烈 | 强烈建议
  信号一致性: 2/2
  平均置信度: 78.9%
  MA20预测: 强势(≥MA20)
  形态预测: 有信号

[+] 3天预测: 推荐 | 建议关注
  信号一致性: 2/2
  平均置信度: 75.2%
  MA20预测: 强势(≥MA20)
  形态预测: 有信号

[*] 5天预测: 观望 | 暂不建议
  信号一致性: 0/2
  平均置信度: 56.9%
  MA20预测: 弱势(<MA20)
  形态预测: 无信号

[OK] 综合预测图表已保存: results/comprehensive_multi_horizon_600519.png
[OK] 600519 预测完成
```

### 6.2 方法B：使用已训练的演示

直接查看步骤5生成的预测结果和图表：
```bash
# 查看生成的图表
explorer results\
```

---

## 📁 文件结构说明

```
up_down_stock_analyst/
├── data/                          # 数据目录
│   ├── all_stock_data.pkl        # ⭐ 所有股票数据（步骤2生成）
│   ├── processed_features.pkl    # ⭐ 处理后特征（步骤3生成）
│   ├── processed_targets.csv     # 目标变量
│   └── stock_*.csv               # 单个股票数据
│
├── models/                        # 模型目录
│   ├── multi_horizon_models.pkl  # ⭐ 多时间窗口模型（步骤5生成）
│   ├── trained_model.pkl         # ⭐ MA20预测模型（步骤4生成）
│   ├── all_trained_models.pkl    # 所有模型
│   ├── feature_list.pkl          # 特征列表
│   └── model_info.pkl            # 模型信息
│
├── results/                       # 结果目录
│   ├── binary_classification_results.png        # MA20分类结果
│   ├── multi_horizon_prediction_*.png          # 多时间窗口预测
│   └── comprehensive_multi_horizon_*.png       # 综合预测
│
├── utils/                         # 工具模块
│   ├── technical_indicators.py   # 技术指标
│   ├── pattern_recognition.py    # 形态识别
│   └── matplotlib_config.py      # 字体配置
│
├── stock_data_downloader.py      # 步骤2：数据下载
├── stock_feature_engineering.py  # 步骤3：特征工程
├── stock_statistical_analysis.py # 步骤4：MA20模型训练
├── multi_horizon_prediction_system.py  # 步骤5：多时间窗口训练⭐
└── stock_multi_horizon_live_prediction.py  # 步骤6：实盘预测⭐
```

---

## 🚀 快速开始（完整命令）

如果你是第一次运行，按顺序执行以下命令：

```bash
# 1. 安装依赖
pip install pandas numpy scipy scikit-learn xgboost lightgbm imbalanced-learn tsfresh matplotlib seaborn efinance akshare pywt

# 2. 下载股票数据
python stock_data_downloader.py

# 3. 特征工程（耗时较长）
python stock_feature_engineering.py

# 4. 训练MA20模型
python stock_statistical_analysis.py

# 5. 训练多时间窗口模型 ⭐
python multi_horizon_prediction_system.py

# 6. 实盘预测
python stock_multi_horizon_live_prediction.py
```

---

## ⚠️ 常见问题

### Q1: 可以跳过某些步骤吗？

**A:** 不建议跳过。每个步骤都依赖前一步的输出：
- 步骤3依赖步骤2的 `all_stock_data.pkl`
- 步骤4依赖步骤3的 `processed_features.pkl`
- 步骤5依赖步骤2的 `all_stock_data.pkl`
- 步骤6依赖步骤4和步骤5的模型

### Q2: 如果中途出错怎么办？

**A:** 可以从出错的步骤重新开始：
```bash
# 例如步骤3出错，只需重新运行步骤3
python stock_feature_engineering.py

# 然后继续后续步骤
python stock_statistical_analysis.py
python multi_horizon_prediction_system.py
```

### Q3: 数据需要更新吗？

**A:** 建议定期更新：
```bash
# 每周或每月重新运行步骤2
python stock_data_downloader.py

# 然后重新训练（步骤3-5）
python stock_feature_engineering.py
python stock_statistical_analysis.py
python multi_horizon_prediction_system.py
```

### Q4: 如何只预测新股票？

**A:** 直接运行步骤6，输入新股票代码：
```bash
python stock_multi_horizon_live_prediction.py
# 输入: 600519,000001,002415
```

系统会实时下载数据并预测。

### Q5: 图表中文乱码怎么办？

**A:** 已自动配置中文字体。如果仍有问题：
```bash
# 测试中文显示
python test_chinese_display.py

# 查看生成的测试图表
explorer results\chinese_display_test.png
```

---

## 📊 性能基准

| 步骤 | 数据量 | 预计耗时 | CPU使用 | 内存使用 |
|-----|-------|---------|---------|---------|
| 步骤2 | 30只股票 | 5-10分钟 | 中等 | ~500MB |
| 步骤3 | 30只股票 | 15-30分钟 | 高 | ~2GB |
| 步骤4 | - | 3-5分钟 | 高 | ~1GB |
| 步骤5 | - | 10-20分钟 | 高 | ~2GB |
| 步骤6 | 单只股票 | <1分钟 | 低 | ~500MB |

---

## 💡 使用技巧

### 技巧1: 批量预测

创建股票列表文件 `predict_list.txt`:
```
600519
000001
002415
600036
```

修改步骤6的脚本读取文件。

### 技巧2: 自动化运行

创建批处理脚本 `run_all.bat` (Windows):
```batch
@echo off
echo 开始完整流程...
python stock_data_downloader.py
python stock_feature_engineering.py
python stock_statistical_analysis.py
python multi_horizon_prediction_system.py
echo 完成！
pause
```

或 shell脚本 `run_all.sh` (Linux/Mac):
```bash
#!/bin/bash
echo "开始完整流程..."
python stock_data_downloader.py
python stock_feature_engineering.py
python stock_statistical_analysis.py
python multi_horizon_prediction_system.py
echo "完成！"
```

### 技巧3: 定时任务

Windows任务计划程序：
```
任务计划程序 → 创建基本任务 → 每周运行 → 启动程序: run_all.bat
```

Linux crontab:
```bash
# 每周日凌晨2点运行
0 2 * * 0 /path/to/run_all.sh
```

---

## 📚 更多文档

- `MULTI_HORIZON_VERIFICATION_GUIDE.md` - 多时间窗口验证详细指南
- `TIME_ALIGNMENT_EXPLANATION.md` - 时间对齐技术说明
- `PATTERN_FEATURES_GUIDE.md` - 形态特征详细说明
- `STOCK_FILTER_CONFIG.md` - 股票过滤配置说明

---

## 🎓 总结

**核心流程：**
1. ✅ 下载数据 → 2. ✅ 特征工程 → 3. ✅ 训练MA20模型 → 4. ⭐ 训练多时间窗口模型 → 5. ⭐ 实盘预测

**关键文件：**
- `data/all_stock_data.pkl` - 原始数据
- `data/processed_features.pkl` - 处理后特征
- `models/multi_horizon_models.pkl` - 多时间窗口模型（最重要）
- `models/trained_model.pkl` - MA20模型

**最重要的命令：**
```bash
python multi_horizon_prediction_system.py  # 训练多时间窗口模型
python stock_multi_horizon_live_prediction.py  # 实盘预测
```

---

**版本：** V1.0  
**更新日期：** 2025-10-05  
**作者：** AI股票分析系统
