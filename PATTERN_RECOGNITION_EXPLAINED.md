# 形态识别详细说明

## 📖 概述

形态识别模块（`utils/pattern_recognition.py`）是一个专门识别股票技术形态的工具，它能够自动识别以下7种重要的技术形态：

1. **趋势识别** - 判断当前是上升、下降还是横盘
2. **反转点识别** - 找出价格趋势改变的关键点
3. **回调识别** - 在上升趋势中的短期回撤
4. **反弹识别** - 在下降趋势中的短期反弹
5. **V型反转** - 快速的趋势逆转
6. **双顶双底** - 经典的反转形态
7. **形态统计** - 各种形态的成功率和强度

---

## 1️⃣ 趋势识别 (Trend Identification)

### 功能：identify_trend()

**作用：** 判断股票当前处于什么趋势中

### 识别逻辑

```python
短期均线 (10天) vs 长期均线 (20天)

如果 短期均线 > 长期均线:
    → 上升趋势 (标记为 1)
    
如果 短期均线 < 长期均线:
    → 下降趋势 (标记为 -1)
    
如果 价格变化 < 2%:
    → 横盘整理 (标记为 0)
```

### 输出特征

| 特征名 | 值 | 含义 |
|--------|---|------|
| Trend | 1 | 上升趋势 📈 |
| Trend | -1 | 下降趋势 📉 |
| Trend | 0 | 横盘整理 ➡️ |

### 实例说明

```
日期      价格    MA10    MA20    趋势
-------------------------------------------
Day 1    100     98      95      上升 (1)
Day 2    102     99      96      上升 (1)
Day 3    101     100     97      上升 (1)
Day 4    98      99      98      横盘 (0)
Day 5    95      97      99      下降 (-1)
```

---

## 2️⃣ 反转点识别 (Reversal Points)

### 功能：identify_reversal_points()

**作用：** 识别价格从上涨转为下跌（顶部）或从下跌转为上涨（底部）的关键点

### 识别逻辑

#### A. 局部极值检测
```python
使用数学方法找到：
- Peak (顶部): 局部最高点
- Trough (底部): 局部最低点

检测窗口: 前后5天
```

#### B. 牛市反转 (Bullish Reversal)
```
条件：
1. 出现底部 (Trough = 1)
2. 反转前10天: 下跌趋势 (价格下降)
3. 反转后10天: 上涨趋势 (价格上升)

结果: Bullish_Reversal = 1 ✅
```

**可视化示例：**
```
价格
  ↑              ↗ 反转后上涨
  |            ↗
  |          ↗
  |        ↗
  |      ↗  ← 牛市反转点 (底部)
  |    ↘
  |  ↘
  ↘ 反转前下跌
────────────────────→ 时间
```

#### C. 熊市反转 (Bearish Reversal)
```
条件：
1. 出现顶部 (Peak = 1)
2. 反转前10天: 上涨趋势
3. 反转后10天: 下跌趋势

结果: Bearish_Reversal = 1 ⚠️
```

**可视化示例：**
```
价格
  ↑    ↗ 反转前上涨
  |  ↗
  |↗
  | ← 熊市反转点 (顶部)
  |  ↘
  |    ↘
  |      ↘
  |        ↘ 反转后下跌
────────────────────→ 时间
```

### 输出特征

| 特征名 | 含义 | 重要性 |
|--------|------|--------|
| Peak | 局部顶部 | ⚠️ 可能卖点 |
| Trough | 局部底部 | ✅ 可能买点 |
| Bullish_Reversal | 牛市反转 | ✅✅ 强烈买入信号 |
| Bearish_Reversal | 熊市反转 | ⚠️⚠️ 强烈卖出信号 |
| Days_Since_Reversal | 距离上次反转天数 | 📊 参考信息 |

### 统计特征

**Reversal_Strength (反转强度)**
- 衡量反转后的价格变化幅度
- 正值：上涨幅度
- 负值：下跌幅度
- 计算：反转后10天的价格变化百分比

---

## 3️⃣ 回调识别 (Pullback)

### 功能：identify_pullback()

**作用：** 在上升趋势中，识别短期的价格回撤

### 什么是回调？

```
回调 = 上升趋势中的短期下跌

特点：
✅ 主趋势仍是上涨
✅ 回撤幅度有限 (5%-20%)
✅ 通常会继续上涨
```

### 识别逻辑

```python
条件1: 当前处于上升趋势 (Trend = 1)
条件2: 价格从近期最高点回撤
条件3: 回撤幅度在 5% - 20% 之间

满足所有条件 → Is_Pullback = 1
```

### 可视化示例

```
价格
  ↑                          ↗ 继续上涨
  |                        ↗
  |                      ↗
  |                    ↗ ← 回调结束 (Pullback_Recovery)
  |      回调 ↘     ↗
  |          5-20% ↘  ← 回调期间 (Is_Pullback = 1)
  |                ↘
  |              ↗ 最高点
  |            ↗
  |          ↗
  |        ↗
  |      ↗ 上升趋势
  |    ↗
  |  ↗
────────────────────────────────→ 时间
```

### 输出特征

| 特征名 | 含义 | 交易信号 |
|--------|------|----------|
| Is_Pullback | 正在回调 | 📊 观察 |
| Pullback_Depth | 回调深度 | 深度越大，反弹潜力越大 |
| Pullback_Recovery | 回调结束 | ✅ 买入信号！ |
| Pullback_Days | 回调持续天数 | 持续时间参考 |
| Pullback_Frequency | 回调频率 | 过去60天回调次数 |
| Avg_Pullback_Depth | 平均回调深度 | 历史平均水平 |
| Pullback_Success_Rate | 回调成功率 | 回调后继续上涨的概率 |

### 实战应用

**回调买入策略：**
```
1. 确认上升趋势 (Trend = 1)
2. 等待回调出现 (Is_Pullback = 1)
3. 回调深度 > 8% (较好的买入点)
4. 出现恢复信号 (Pullback_Recovery = 1)
5. 历史成功率 > 60% (Pullback_Success_Rate > 0.6)

满足条件 → 买入 ✅
```

---

## 4️⃣ 反弹识别 (Bounce)

### 功能：identify_bounce()

**作用：** 在下降趋势中，识别短期的价格反弹

### 什么是反弹？

```
反弹 = 下降趋势中的短期上涨

特点：
⚠️ 主趋势仍是下跌
⚠️ 反弹幅度有限 (5%-20%)
⚠️ 通常会继续下跌
```

### 识别逻辑

```python
条件1: 当前处于下降趋势 (Trend = -1)
条件2: 价格从近期最低点反弹
条件3: 反弹幅度在 5% - 20% 之间

满足所有条件 → Is_Bounce = 1
```

### 可视化示例

```
价格
  ↑
  |  ↘
  |    ↘
  |      ↘ 下降趋势
  |        ↘
  |          ↘
  |            ↗ ← 反弹期间 (Is_Bounce = 1)
  |          ↗  5-20%
  |        ↗
  |      ↗ 最低点
  |        ↘ ← 反弹结束 (Bounce_End)
  |          ↘
  |            ↘ 继续下跌
────────────────────────────────→ 时间
```

### 输出特征

| 特征名 | 含义 | 交易信号 |
|--------|------|----------|
| Is_Bounce | 正在反弹 | ⚠️ 谨慎 |
| Bounce_Height | 反弹高度 | 反弹力度 |
| Bounce_End | 反弹结束 | 🚨 继续看跌 |
| Bounce_Days | 反弹持续天数 | 持续时间参考 |
| Bounce_Frequency | 反弹频率 | 过去60天反弹次数 |
| Avg_Bounce_Height | 平均反弹高度 | 历史平均水平 |
| Bounce_Success_Rate | 反弹"成功"率 | 反弹后继续下跌的概率 |

### 实战应用

**反弹做空策略（高级）：**
```
1. 确认下降趋势 (Trend = -1)
2. 等待反弹出现 (Is_Bounce = 1)
3. 反弹高度 > 8%
4. 出现反弹结束信号 (Bounce_End = 1)
5. 历史"成功率" > 60% (继续下跌概率高)

满足条件 → 做空或避免买入 ⚠️
```

---

## 5️⃣ V型反转 (V-Reversal)

### 功能：identify_v_reversal()

**作用：** 识别快速、剧烈的趋势逆转

### 什么是V型反转？

```
V型反转 = 价格快速下跌后立即快速上涨
倒V反转 = 价格快速上涨后立即快速下跌

特点：
⚡ 变化快速
⚡ 幅度大 (>10%)
⚡ 不经过盘整
```

### 识别逻辑

#### A. V型底部 (Bullish V-Reversal)
```python
检测窗口: 10天

条件：
1. 前10天快速下跌 > 10%
2. 后10天快速上涨 > 10%
3. 中间没有明显停顿

结果: V_Reversal_Bullish = 1 ✅
```

**可视化：**
```
价格
  ↑              ↗↗↗ 快速上涨 >10%
  |            ↗
  |          ↗
  |        ↗
  |      ↗ ← V型底部
  |    ↘
  |  ↘
  ↘↘↘ 快速下跌 >10%
────────────────────→ 时间
```

#### B. 倒V型顶部 (Bearish V-Reversal)
```python
条件：
1. 前10天快速上涨 > 10%
2. 后10天快速下跌 > 10%
3. 中间没有明显停顿

结果: V_Reversal_Bearish = 1 ⚠️
```

**可视化：**
```
价格
  ↑  ↗↗↗ 快速上涨 >10%
  |    ↗
  |      ↗
  |        ↗ ← 倒V型顶部
  |        ↘
  |      ↘
  |    ↘
  |  ↘
  ↘↘↘ 快速下跌 >10%
────────────────────→ 时间
```

### 输出特征

| 特征名 | 含义 | 信号强度 |
|--------|------|----------|
| V_Reversal_Bullish | V型底部 | ✅✅✅ 强烈买入 |
| V_Reversal_Bearish | 倒V顶部 | ⚠️⚠️⚠️ 强烈卖出 |

### 实战意义

```
V型反转的特点：
✅ 信号强烈：价格变化剧烈
✅ 时机明确：反转迅速
✅ 成功率高：通常预示重要转折

交易建议：
- V型底部：积极买入
- 倒V顶部：及时止盈或离场
```

---

## 6️⃣ 双顶双底 (Double Top/Bottom)

### 功能：identify_double_top_bottom()

**作用：** 识别经典的反转形态

### 什么是双顶双底？

```
双顶 (M型) = 两个相近的高点，中间有回调
双底 (W型) = 两个相近的低点，中间有反弹

特点：
📊 经典形态
📊 预示趋势反转
📊 成功率较高
```

### 识别逻辑

#### A. 双顶 (Double Top)
```python
条件：
1. 找到两个局部最高点 (Peak)
2. 两个顶部相距 20-60天
3. 两个顶部价格相差 < 2%
4. 中间回调幅度 > 5%

结果: Double_Top = 1 ⚠️⚠️
```

**可视化：**
```
价格
  ↑        顶2
  |       ↗ ↘
  |      ↗   ↘
  |     ↗     ↘
  |    ↗  回   ↘
  | 顶1   调    ↘
  |  ↗↘   >5%   ↘ 突破后下跌
  | ↗  ↘       ↘
  |      ↘     ↘
──────────────────→ 时间
    M型形态 (双顶)
```

#### B. 双底 (Double Bottom)
```python
条件：
1. 找到两个局部最低点 (Trough)
2. 两个底部相距 20-60天
3. 两个底部价格相差 < 2%
4. 中间反弹幅度 > 5%

结果: Double_Bottom = 1 ✅✅
```

**可视化：**
```
价格
  ↑    ↗ 突破后上涨
  |   ↗
  |  ↗   反弹 ↗
  | ↗    >5% ↗
  |  ↗↘     ↗
  |底1 ↘   ↗ 底2
  |     ↘ ↗
  |      ↘↗
──────────────────→ 时间
    W型形态 (双底)
```

### 输出特征

| 特征名 | 含义 | 交易信号 |
|--------|------|----------|
| Double_Top | 双顶形态 | ⚠️⚠️ 看跌信号 |
| Double_Bottom | 双底形态 | ✅✅ 看涨信号 |

### 实战应用

**双底买入策略：**
```
1. 识别到双底形态 (Double_Bottom = 1)
2. 价格突破两个底部之间的最高点
3. 配合成交量放大
4. 确认突破有效 (回测不破)

满足条件 → 买入 ✅✅
```

**双顶卖出策略：**
```
1. 识别到双顶形态 (Double_Top = 1)
2. 价格跌破两个顶部之间的最低点
3. 配合成交量放大
4. 确认跌破有效

满足条件 → 卖出 ⚠️⚠️
```

---

## 7️⃣ 形态统计 (Pattern Statistics)

### 功能：calculate_pattern_statistics()

**作用：** 计算各种形态的成功率、频率等统计指标

### 统计指标

#### A. 频率指标
```
Pullback_Frequency: 过去60天回调次数
Bounce_Frequency: 过去60天反弹次数

用途：判断市场波动性
```

#### B. 深度/高度指标
```
Avg_Pullback_Depth: 平均回调深度
Avg_Bounce_Height: 平均反弹高度

用途：判断正常波动范围
```

#### C. 成功率指标
```
Pullback_Success_Rate: 回调后继续上涨的概率
Bounce_Success_Rate: 反弹后继续下跌的概率

用途：评估形态可靠性
```

### 汇总函数：summarize_patterns()

**输出示例：**
```python
{
    '反转次数': {
        '牛市反转': 5,      # 5次底部反转
        '熊市反转': 3,      # 3次顶部反转
        'V型底部': 2,       # 2次V型底
        '倒V顶部': 1        # 1次倒V顶
    },
    '回调统计': {
        '回调次数': 15,            # 共15次回调
        '平均回调深度': '8.5%',    # 平均回调8.5%
        '最大回调深度': '18.2%',   # 最大回调18.2%
        '回调成功率': '72%'        # 72%回调后继续上涨
    },
    '反弹统计': {
        '反弹次数': 12,            # 共12次反弹
        '平均反弹高度': '7.3%',    # 平均反弹7.3%
        '最大反弹高度': '16.8%',   # 最大反弹16.8%
        '反弹成功率': '68%'        # 68%反弹后继续下跌
    },
    '特殊形态': {
        '双顶形态': 2,      # 2次双顶
        '双底形态': 3       # 3次双底
    }
}
```

---

## 📊 完整特征列表

形态识别模块总共提供 **31个特征**：

### 基础形态特征 (8个)
1. `Peak` - 局部顶部
2. `Trough` - 局部底部
3. `Bullish_Reversal` - 牛市反转
4. `Bearish_Reversal` - 熊市反转
5. `Days_Since_Reversal` - 距离反转天数
6. `Trend` - 当前趋势
7. `V_Reversal_Bullish` - V型底部
8. `V_Reversal_Bearish` - 倒V顶部

### 回调相关特征 (10个)
9. `Recent_High` - 近期最高价
10. `Drawdown_From_High` - 从高点回撤
11. `Is_Pullback` - 是否在回调
12. `Pullback_Depth` - 回调深度
13. `Pullback_Recovery` - 回调恢复
14. `Pullback_Days` - 回调天数
15. `Pullback_Frequency` - 回调频率
16. `Avg_Pullback_Depth` - 平均回调深度
17. `Pullback_Success` - 单次成功
18. `Pullback_Success_Rate` - 成功率

### 反弹相关特征 (10个)
19. `Recent_Low` - 近期最低价
20. `Rally_From_Low` - 从低点反弹
21. `Is_Bounce` - 是否在反弹
22. `Bounce_Height` - 反弹高度
23. `Bounce_End` - 反弹结束
24. `Bounce_Days` - 反弹天数
25. `Bounce_Frequency` - 反弹频率
26. `Avg_Bounce_Height` - 平均反弹高度
27. `Bounce_Success` - 单次成功
28. `Bounce_Success_Rate` - 成功率

### 其他特征 (3个)
29. `Reversal_Strength` - 反转强度
30. `Double_Top` - 双顶形态
31. `Double_Bottom` - 双底形态

---

## 💡 实战应用策略

### 策略1: 趋势追踪 + 回调买入

```python
买入条件：
1. Trend = 1 (上升趋势)
2. Pullback_Recovery = 1 (回调结束)
3. Pullback_Depth > 0.08 (回调够深)
4. Pullback_Success_Rate > 0.6 (历史成功率高)

结果：在上升趋势中低位买入
```

### 策略2: 反转抓底

```python
买入条件：
1. Bullish_Reversal = 1 (牛市反转)
   或
   V_Reversal_Bullish = 1 (V型底部)
   或
   Double_Bottom = 1 (双底形态)

2. Reversal_Strength > 0.05 (反转强度>5%)
3. 近期无多次失败反转

结果：在重要底部买入
```

### 策略3: 顶部逃顶

```python
卖出条件：
1. Bearish_Reversal = 1 (熊市反转)
   或
   V_Reversal_Bearish = 1 (倒V顶部)
   或
   Double_Top = 1 (双顶形态)

2. Trend 由 1 转为 -1 (趋势反转确认)

结果：在顶部及时离场
```

### 策略4: 综合信号验证

```python
强烈买入 (多信号共振):
1. Bullish_Reversal = 1 (反转信号)
2. Double_Bottom = 1 (双底确认)
3. Pullback_Recovery = 1 (回调结束)
4. Pullback_Success_Rate > 0.7 (高成功率)

多个信号同时出现 → 强烈买入 ✅✅✅
```

---

## ⚙️ 参数调整建议

### 保守型交易者

```python
# 更严格的条件
pullback_threshold = 0.08      # 回调>8%才关注
bounce_threshold = 0.08        # 反弹>8%才关注
v_reversal_threshold = 0.15    # V型反转>15%
success_rate_min = 0.70        # 成功率>70%
```

### 激进型交易者

```python
# 更宽松的条件
pullback_threshold = 0.03      # 回调>3%就关注
bounce_threshold = 0.03        # 反弹>3%就关注
v_reversal_threshold = 0.08    # V型反转>8%
success_rate_min = 0.55        # 成功率>55%
```

---

## 📈 使用示例

### 在多时间窗口预测中的应用

```python
from utils.pattern_recognition import add_pattern_features

# 添加形态特征
df = add_pattern_features(stock_data)

# 查看最近的信号
recent_signals = df.tail(10)[[
    'Bullish_Reversal', 
    'Bearish_Reversal',
    'Is_Pullback',
    'Pullback_Recovery',
    'V_Reversal_Bullish',
    'Double_Bottom'
]]

print(recent_signals)
```

### 统计分析

```python
from utils.pattern_recognition import summarize_patterns

# 获取形态统计
summary = summarize_patterns(df)

# 打印统计结果
import json
print(json.dumps(summary, indent=2, ensure_ascii=False))
```

---

## 🎯 总结

### 核心价值

1. **自动化识别** - 无需人工盯盘，自动识别关键形态
2. **量化分析** - 将技术形态转化为可计算的特征
3. **成功率统计** - 提供历史成功率参考
4. **多重验证** - 31个特征互相验证，提高准确性

### 适用场景

| 场景 | 推荐使用的特征 |
|------|---------------|
| 短线交易 | V型反转、回调恢复 |
| 中线交易 | 趋势跟踪、双底双顶 |
| 波段操作 | 回调买入、反弹避险 |
| 风险控制 | 熊市反转、倒V顶部 |

### 注意事项

⚠️ **形态识别不是万能的：**
- 需要结合其他指标（成交量、资金流等）
- 需要考虑市场整体环境
- 历史成功率不代表未来表现
- 建议与多时间窗口验证结合使用

---

**版本：** V1.0  
**更新日期：** 2025-10-05  
**相关文档：** 
- `PATTERN_FEATURES_GUIDE.md` - 形态特征快速指南
- `MULTI_HORIZON_VERIFICATION_GUIDE.md` - 多时间窗口验证
- `COMPLETE_RUNNING_GUIDE.md` - 完整运行指南
